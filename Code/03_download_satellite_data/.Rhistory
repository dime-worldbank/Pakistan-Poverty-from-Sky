# Stack Rasters
# Google Earth Engine downloaded landsat bands as separate tifs
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
# Stack Rasters ----------------------------------------------------------------
unstacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "unstacked")
unstacked_files <- list.files(unstacked_file_path)
unstacked_files_i = unstacked_files[500]
print(unstacked_files_i)
b1 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B1_median.tif"))
plot(b1)
print(unstacked_files_i)
b1 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B1_median.tif"))
b2 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B2_median.tif"))
b3 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B3_median.tif"))
b4 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B4_median.tif"))
b5 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B5_median.tif"))
b6 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B6_median.tif"))
b7 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B7_median.tif"))
r_stacked <- stack(b1, b2, b3, b4, b5, b6, b7)
plot(b4)
# Stack Rasters
# Google Earth Engine downloaded landsat bands as separate tifs
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
# Stack Rasters ----------------------------------------------------------------
unstacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "unstacked")
unstacked_files <- list.files(unstacked_file_path)
unstacked_files_i = unstacked_files[500]
for(unstacked_files_i in unstacked_files){
print(unstacked_files_i)
b1 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B1_median.tif"))
b2 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B2_median.tif"))
b3 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B3_median.tif"))
b4 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B4_median.tif"))
b5 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B5_median.tif"))
b6 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B6_median.tif"))
b7 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B7_median.tif"))
r_stacked <- stack(b1, b2, b3, b4, b5, b6, b7)
writeRaster(r_stacked, file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked", paste0(unstacked_files_i, ".tif")),overwrite=T)
rm(r_stacked,b1, b2, b3, b4, b5, b6, b7)
}
# Stack Rasters
# Google Earth Engine downloaded landsat bands as separate tifs
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
# Stack Rasters ----------------------------------------------------------------
unstacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "unstacked")
unstacked_files <- list.files(unstacked_file_path)
unstacked_files_i = unstacked_files[500]
for(unstacked_files_i in unstacked_files){
print(unstacked_files_i)
b1 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B1_median.tif"))
b2 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B2_median.tif"))
b3 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B3_median.tif"))
b4 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B4_median.tif"))
b5 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B5_median.tif"))
b6 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B6_median.tif"))
b7 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B7_median.tif"))
r_stacked <- stack(b1, b2, b3, b4, b5, b6, b7)
writeRaster(r_stacked, file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked", paste0(unstacked_files_i, ".tif")),overwrite=T)
rm(r_stacked,b1, b2, b3, b4, b5, b6, b7)
}
stacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked")
stacked_file_path <- list.files(stacked_file_path)
stacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked")
stacked_file_path <- list.files(stacked_file_path)
r <- stack(stacked_file_path[1])
# Merge Rasters
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
stacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked")
stacked_file_path <- list.files(stacked_file_path)
r <- stack(stacked_file_path[1])
r <- brick(stacked_file_path[1])
stacked_file_path[1]
help(list.files)
stacked_file_path <- list.files(stacked_file_path, full.names=T)
r <- brick(stacked_file_path[1])
stacked_file_path
# Merge Rasters
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
stacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked")
stacked_file_path <- list.files(stacked_file_path, full.names=T)
stacked_file_path
stacked_file_path[1]
r <- brick(stacked_file_path[1])
r
r1 <- brick(stacked_file_path[1])
r2 <- brick(stacked_file_path[1])
r_all <- mosaic(r1, r2)
help(mosaic)
r_all <- mosaic(r1, r2, fun=max)
plot(r_all)
plot(r1)
plot(r_all)
r1 <- brick(stacked_file_path[1])
r2 <- brick(stacked_file_path[2])
plot(r2)
r_all <- mosaic(r1, r2, fun=max)
plot(r_all)
r_all <- mosaic(r_all, brick(stacked_file_path[3]), fun=max)
r3 <- brick(stacked_file_path[3])
plot(r3)
r_all <- mosaic(r1, r2, r3, fun=max)
# Load Shapefile ---------------------------------------------------------------
st_read(file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser.geojson"))
library(sf)
# Load Shapefile ---------------------------------------------------------------
st_read(file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser.geojson"))
# Load Shapefile ---------------------------------------------------------------
uc_sdf <- st_read(file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser.geojson")) %>% as("Spatial")
plot(uc_sdf)
head(uc_sdf)
# Merge Rasters
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
stacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked")
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
library(sf)
# Load Shapefile ---------------------------------------------------------------
uc_sdf <- st_read(file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser.geojson")) %>% as("Spatial")
library(velox)
head(uc_sdf)
id <- "uc_1"
# Load Shapefile ---------------------------------------------------------------
uc_sdf <- st_read(file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser.geojson")) %>% as("Spatial")
id <- "uc_1"
r <- brick(stacked_file_path, "uc_1.tiff")
# Merge Rasters
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
stacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked")
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
library(sf)
# Load Shapefile ---------------------------------------------------------------
uc_sdf <- st_read(file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser.geojson")) %>% as("Spatial")
id <- "uc_1"
r <- brick(stacked_file_path, "uc_1.tiff")
r <- brick(stacked_file_path, "uc_1.tif")
r <- brick(file.path(stacked_file_path, "uc_1.tif"))
r
cellStats(r, stat='mean')
cellStats(r, stat='mean') / 1000 / 1000
cellStats(r, stat='mean') * 0.0001 / 1000
cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
names(landsat_band_mean) <- paste0("band_",1:7,"_mean")
landsat_band_mean
landsat_band_mean$ud_id <- id
landsat_band_mean
r <- brick(file.path(stacked_file_path, "uc_1.tif"))
landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- as.data.frame(landsat_band_mean)
landsat_band_mean
r <- brick(file.path(stacked_file_path, "uc_1.tif"))
landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("band_",1:7,"_mean")
landsat_band_mean$ud_id <- id
landsat_band_mean
landsat_average <- lapply(uc_sdf$uc_id[1:10], function(id){
print(id)
landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("band_",1:7,"_mean")
landsat_band_mean$ud_id <- id
return(landsat_band_mean)
}) %>%
bind_rows
library(dplyr)
uc_sdf$uc_id[1:10]
# Load Shapefile ---------------------------------------------------------------
uc_sdf <- st_read(file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser.geojson")) %>% as("Spatial")
uc_sdf$uc_id <- as.character(uc_sdf$uc_id)
landsat_average <- lapply(uc_sdf$uc_id[1:10], function(id){
print(id)
landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("band_",1:7,"_mean")
landsat_band_mean$ud_id <- id
return(landsat_band_mean)
}) %>%
bind_rows
head(landsat_average)
landsat_average <- lapply(uc_sdf$uc_id[1:10], function(id){
print(id)
r <- brick(file.path(stacked_file_path, id))
landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("band_",1:7,"_mean")
landsat_band_mean$ud_id <- id
return(landsat_band_mean)
}) %>%
bind_rows
landsat_average <- lapply(uc_sdf$uc_id[1:10], function(id){
print(id)
r <- brick(file.path(stacked_file_path, paste0(id,".tif")))
landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("band_",1:7,"_mean")
landsat_band_mean$ud_id <- id
return(landsat_band_mean)
}) %>%
bind_rows
landsat_average
# Stack Rasters
# Google Earth Engine downloaded landsat bands as separate tifs
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
# Stack Rasters ----------------------------------------------------------------
unstacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "unstacked")
unstacked_files <- list.files(unstacked_file_path)
unstacked_files_i = unstacked_files[500]
print(unstacked_files_i)
b1 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B1_median.tif"))
b2 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B2_median.tif"))
b3 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B3_median.tif"))
b4 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B4_median.tif"))
b5 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B5_median.tif"))
b6 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B6_median.tif"))
b7 <- raster(file.path(unstacked_file_path, unstacked_files_i, "B7_median.tif"))
r_stacked <- stack(b1, b2, b3, b4, b5, b6, b7)
plot(b1)
plot(b2)
plot(b3)
plot(b4)
plot(b5)
plot(b6)
plot(b5)
plot(b3)
plot(b6)
landsat_average <- lapply(uc_sdf$uc_id[1:10], function(id){
print(id)
r <- brick(file.path(stacked_file_path, paste0(id,".tif")))
#landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- cellStats(r, stat='mean') * 0.0001 / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("band_",1:7,"_mean")
landsat_band_mean$ud_id <- id
return(landsat_band_mean)
}) %>%
bind_rows
head(landsat_average)
uc_sdfa <- merge(uc_sdf, landsat_average, by="uc_id", all.x=T)
uc_sdf$uc_id
landsat_average
uc_sdfa <- merge(uc_sdf, landsat_average, by="uc_id", all.x=T)
uc_sdf$uc_id %>% table %>% table
uc_sdfa <- merge(uc_sdf, landsat_average, by="uc_id", all.x=T)
uc_sdfa <- merge(uc_sdf, landsat_average, by="uc_id", all.x=F)
uc_sdfa <- merge(uc_sdf, landsat_average, by="uc_id", all.x=T)
uc_sdfa <- merge(uc_sdf@data, landsat_average, by="uc_id", all.x=T)
uc_sdf$uc_id
landsat_average$uc_ud
landsat_average <- lapply(uc_sdf$uc_id[1:10], function(id){
print(id)
r <- brick(file.path(stacked_file_path, paste0(id,".tif")))
#landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- cellStats(r, stat='mean') * 0.0001 / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("band_",1:7,"_mean")
landsat_band_mean$ud_id <- id
return(landsat_band_mean)
}) %>%
bind_rows
landsat_average
landsat_average <- lapply(uc_sdf$uc_id[1:10], function(id){
print(id)
r <- brick(file.path(stacked_file_path, paste0(id,".tif")))
#landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- cellStats(r, stat='mean') * 0.0001 / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("band_",1:7,"_mean")
landsat_band_mean$uc_id <- id
return(landsat_band_mean)
}) %>%
bind_rows
uc_sdfa <- merge(uc_sdf, landsat_average, by="uc_id", all.x=T)
uc_sdfa
View(uc_sdfa)
View(uc_sdfa@data)
uc_sf <- st_as_sf(uc_sdf)
uc_sf
st_write(uc_sf, file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser_satelliteaverages.geojson"),delete_dsn=T)
uc_sf
# Merge Rasters
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
stacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked")
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
library(sf)
library(dplyr)
# Load Shapefile ---------------------------------------------------------------
uc_sdf <- st_read(file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser.geojson")) %>% as("Spatial")
uc_sdf$uc_id <- as.character(uc_sdf$uc_id)
# Extract Satellite Imagery to Shapefile ---------------------------------------
landsat_average <- lapply(uc_sdf$uc_id[1:10], function(id){
print(id)
r <- brick(file.path(stacked_file_path, paste0(id,".tif")))
#landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- cellStats(r, stat='mean') * 0.0001 / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("landsat2010_band_",1:7,"_mean")
landsat_band_mean$uc_id <- id
return(landsat_band_mean)
}) %>%
bind_rows
uc_sdf <- merge(uc_sdf, landsat_average, by="uc_id", all.x=T)
uc_sf <- st_as_sf(uc_sdf)
# Export -----------------------------------------------------------------------
st_write(uc_sf, file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser_satelliteaverages.geojson"),delete_dsn=T)
uc_sf
View(uc_sf)
# Extract Satellite Imagery to Shapefile ---------------------------------------
#### DMSP-OLS
year <- 2012
viirs <- raster(file.path(project_file_path, "Data", "RawData", "VIIRS", "VIIRS Annual", paste0("pak_viirs_median_",year,".tif")))
library(velox)
# Extract Satellite Imagery to Shapefile ---------------------------------------
#### DMSP-OLS
year <- 2012
viirs <- raster(file.path(project_file_path, "Data", "RawData", "VIIRS", "VIIRS Annual", paste0("pak_viirs_median_",year,".tif")))
velox(viirs)$extract(uc_sdf, function(x) mean(x, na.rm=T))
# Extract Satellite Imagery to Shapefile ---------------------------------------
#### DMSP-OLS
for(year in 2012:2018){
print(year)
viirs <- raster(file.path(project_file_path, "Data", "RawData", "VIIRS", "VIIRS Annual", paste0("pak_viirs_median_",year,".tif")))
uc_sdf[[paste0("viirs_",year,"_mean")]] <- velox(viirs)$extract(uc_sdf, function(x) mean(x, na.rm=T))
uc_sdf[[paste0("viirs_",year,"_median")]] <- velox(viirs)$extract(uc_sdf, function(x) median(x, na.rm=T))
}
# Merge Rasters
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
stacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked")
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
library(sf)
library(dplyr)
library(velox)
# Load Shapefile ---------------------------------------------------------------
uc_sdf <- st_read(file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser.geojson")) %>% as("Spatial")
uc_sdf$uc_id <- as.character(uc_sdf$uc_id)
# Extract Satellite Imagery to Shapefile ---------------------------------------
#### DMSP-OLS
for(year in 1992:2013){
print(year)
dmspols <- raster(file.path(project_file_path, "Data", "RawData", "DMSPOLS", paste0("pak_dmspols_",year,".tif")))
uc_sdf[[paste0("dmspols_",year,"_mean")]] <- velox(dmspols)$extract(uc_sdf, function(x) mean(x, na.rm=T))
}
#### VIIRS
for(year in 2012:2018){
print(year)
viirs <- raster(file.path(project_file_path, "Data", "RawData", "VIIRS", "VIIRS Annual", paste0("pak_viirs_median_",year,".tif")))
uc_sdf[[paste0("viirs_",year,"_mean")]] <- velox(viirs)$extract(uc_sdf, function(x) mean(x, na.rm=T))
}
#### Landsat
#### Landsat
landsat_average <- lapply(uc_sdf$uc_id[1:10], function(id){
print(id)
r <- brick(file.path(stacked_file_path, paste0(id,".tif")))
#landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- cellStats(r, stat='mean') * 0.0001 / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("landsat2010_band_",1:7,"_mean")
landsat_band_mean$uc_id <- id
return(landsat_band_mean)
}) %>%
bind_rows
uc_sdf <- merge(uc_sdf, landsat_average, by="uc_id", all.x=T)
uc_sf <- st_as_sf(uc_sdf)
View(uc_sf)
# Merge Rasters
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "C:/Users/wb521633/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
if(Sys.info()[["user"]] == "robmarty") project_file_path <- "~/Dropbox/World Bank/IEs/Pakistan Poverty Estimation from Satellites"
stacked_file_path <- file.path(project_file_path, "Data", "RawData", "Landsat", "unioncouncil", "stacked")
library(stringr)
library(ggmap)
library(rgdal)
library(rgeos)
library(raster)
library(sf)
library(dplyr)
library(velox)
# Load Shapefile ---------------------------------------------------------------
uc_sdf <- st_read(file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser.geojson")) %>% as("Spatial")
uc_sdf$uc_id <- as.character(uc_sdf$uc_id)
# Extract Satellite Imagery to Shapefile ---------------------------------------
#### DMSP-OLS
for(year in 1992:2013){
print(year)
dmspols <- raster(file.path(project_file_path, "Data", "RawData", "DMSPOLS", paste0("pak_dmspols_",year,".tif")))
uc_sdf[[paste0("dmspols_",year,"_mean")]] <- velox(dmspols)$extract(uc_sdf, function(x) mean(x, na.rm=T))
}
#### VIIRS
for(year in 2012:2018){
print(year)
viirs <- raster(file.path(project_file_path, "Data", "RawData", "VIIRS", "VIIRS Annual", paste0("pak_viirs_median_",year,".tif")))
uc_sdf[[paste0("viirs_",year,"_mean")]] <- velox(viirs)$extract(uc_sdf, function(x) mean(x, na.rm=T))
}
#### Landsat
landsat_average <- lapply(uc_sdf$uc_id, function(id){
print(id)
r <- brick(file.path(stacked_file_path, paste0(id,".tif")))
#landsat_band_mean <- cellStats(r, stat='mean') * c(0.0001, 0.0001, 0.0001, 0.0001, 0.0001, 0.1, 0.0001) / 1000
landsat_band_mean <- cellStats(r, stat='mean') * 0.0001 / 1000
landsat_band_mean <- as.data.frame(t(landsat_band_mean))
names(landsat_band_mean) <- paste0("landsat2010_band_",1:7,"_mean")
landsat_band_mean$uc_id <- id
return(landsat_band_mean)
}) %>%
bind_rows
uc_sdf <- merge(uc_sdf, landsat_average, by="uc_id", all.x=T)
uc_sf <- st_as_sf(uc_sdf)
# Export -----------------------------------------------------------------------
st_write(uc_sf, file.path(project_file_path, "Data", "FinalData", "UC with NSER Data", "uc_nser_satelliteaverages.geojson"),delete_dsn=T)
View(uc_sf)
uc_sf$landsat2010_band_2_mean %>% hist()
uc_sf$landsat2010_band_1_mean %>% hist()
uc_sf$landsat2010_band_3_mean %>% hist()
uc_sf$landsat2010_band_4_mean %>% hist()
uc_sf$landsat2010_band_5_mean %>% hist()
uc_sf$landsat2010_band_6_mean %>% hist()
library(sf)
a <- st_read("~/Desktop/FinalData/UC with NSER Data/uc_nser.geojson")
a <- st_read("~/Desktop/FinalData/UC with NSER Data/uc_nser.geojson") %>% as("Spatial")
plot(a)
names(a)
a <- st_read("~/Desktop/FinalData/UC with NSER Data/uc_nser_satelliteaverages.geojson") %>% as("Spatial")
View(a)
View(a@data)
names(a@data)
head(a)
