as.data.frame %>%
dplyr::rename(word = ".") %>%
dplyr::rename(freq = Freq)
# Frequency of words within 1 word of number
words_near_numbers_sum1_df <- c(words_near_numbers_df$Vm1,
words_near_numbers_df$V1) %>%
table %>%
as.data.frame %>%
dplyr::rename(word = ".") %>%
dplyr::rename(freq = Freq)
words_near_numbers_sum1_df <- words_near_numbers_sum1_df[is.na(as.numeric(as.character(words_near_numbers_sum1_df$word))),]
words_near_numbers_sum12_df <- words_near_numbers_sum12_df[is.na(as.numeric(as.character(words_near_numbers_sum12_df$word))),]
head(words_near_numbers_sum1_df)
View(words_near_numbers_sum1_df)
View(words_near_numbers_sum12_df)
head(words_near_numbers_df)
words_near_numbers_df$words_all <- paste(words_near_numbers_df$Vm2, words_near_numbers_df$Vm1,
words_near_numbers_df$V1, words_near_numbers_df$V2)
# Grab ones with a currency
words_near_numbers_df <- words_near_numbers_df[words_near_numbers_df$words_all %in% CURRENCY_WORDS,]
# Grab ones with a currency
words_near_numbers_df_currency <- words_near_numbers_df[words_near_numbers_df$words_all %in% CURRENCY_WORDS,]
View(words_near_numbers_df_currency)
words_near_numbers_df <- lapply(srar_df$commentaire_srar, extract_words_near_strings, 2) %>% bind_rows
words_near_numbers_df$words_all <- paste(words_near_numbers_df$Vm2, words_near_numbers_df$Vm1,
words_near_numbers_df$V1, words_near_numbers_df$V2)
# Grab ones with a currency
words_near_numbers_df_currency <- words_near_numbers_df[grepl(CURRENCY_WORDS, words_near_numbers_df$words_all),]
# Grab ones with a currency
paste(CURRENCY_WORDS, collapse="|")
# Grab ones with a currency
words_near_numbers_df_currency <- words_near_numbers_df[grepl(paste(CURRENCY_WORDS, collapse="|"), words_near_numbers_df$words_all),]
View(words_near_numbers_df_currency)
words_near_numbers_df$words_all <- paste(words_near_numbers_df$Vm2, words_near_numbers_df$Vm1,
words_near_numbers_df$V0,
words_near_numbers_df$V1, words_near_numbers_df$V2)
# Grab ones with a currency
words_near_numbers_df_currency <- words_near_numbers_df[grepl(paste(CURRENCY_WORDS, collapse="|"), words_near_numbers_df$words_all),]
View(words_near_numbers_df_currency)
# Explore Patterns in Data
# Load Data --------------------------------------------------------------------
srar_df <- readRDS(file.path(rawdata_file_path, "mergedFiles","srar_dau_bsc_merged_cleaned_metrics.Rds"))
# Text Analysis of Comments
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "Z:"
srar_comments_file_path <- file.path(project_file_path, "Experiment","Data","DATAIN","SRAR_Comments")
code_file_path <- file.path(project_file_path, "Madagascar_project", "dofiles", "analysis", "text_analysis")
rawdata_file_path <- file.path(project_file_path, "Madagascar_project", "dataOUT", "commentsOUT", "rawdata")
library(readxl)
library(dplyr)
library(stringr)
library(ggplot2)
library(readstata13)
library(doBy)
library(quanteda)
library(caret)
library(tm)
library(haven)
library(ggpubr)
library(stringi)
WEIGHT_VOLUME_WORDS <- c("carton", "kg","metre", "piece", "sac", "tonne")
CURRENCY_WORDS <- c("usd", "eur")
run_scripts <- F
# Scripts ----------------------------------------------------------------------
if(run_scripts){
# Append BSC, DAU and SRAR Files
source("append_files.R")
# Clean and Add Metrics
source("clean_addmetrics.R")
# Explore patterns in data
# Figure/tables
# Add Metrics to BSC & DAU Files
source("addmetrics_bscdaudata.R")
# 2. File from Eva -----------------------------------------------------------
source("clean_addmetrics_evadata.R")
source("words_predictive_categories.R")
}
# Clean and Add Metrics to Data
# Load Data --------------------------------------------------------------------
srar_df <- readRDS(file.path(rawdata_file_path, "mergedFiles","srar_dau_bsc_merged.Rds"))
# Create Variable if No Issues -------------------------------------------------
# subset to just variables that indicate problem
#srar_df_issues <- subset(srar_df, select=-c(annee,bureau,serie_type,numero,dau,
#                                            bsc,commentaire_srar,commentaire_srar_new,
#                                            commentaire_profiler,commentaire_profiler_new))
# Create Variables of Original Comments (Before Cleaning) ---------------------
srar_df$commentaire_srar_original <- srar_df$commentaire_srar
# Clean and Add Metrics to Data
# Load Data --------------------------------------------------------------------
srar_df <- readRDS(file.path(rawdata_file_path, "mergedFiles","srar_dau_bsc_merged.Rds"))
# Create Variable if No Issues -------------------------------------------------
# subset to just variables that indicate problem
#srar_df_issues <- subset(srar_df, select=-c(annee,bureau,serie_type,numero,dau,
#                                            bsc,commentaire_srar,commentaire_srar_new,
#                                            commentaire_profiler,commentaire_profiler_new))
srar_df_sub <- srar_df[grepl(" 000", srar_df$commentaire_profiler),]
nrow(srar_df_sub)
srar_df_sub <- srar_df[grepl(" 000", srar_df$commentaire_srar),]
nrow(srar_df_sub)
View(srar_df_sub)
srar_df_sub$commentaire_srar
help(gsub)
# Add comma where one is implied
#    Cases like the following:
#    "de « Cabine nue Camion » = 1 000 EURO FOB/Pce (cf. C 9955 21 TO/2018)"
#    we want a comma here: » = 1,000 EURO
#    but not here: 9955 21
string <- "de « Cabine nue Camion » = 1 000 EURO FOB/Pce (cf. C 9955 21 TO/2018)"
gsub("[[:digit:]][[:digit:]][[:digit:]] 000", "BLARG", string)
gsub("[[:digit:]] 000", "BLARG", string)
gsub("([[:digit:]][[:digit:]][[:digit:]] )(000)", "BLARG", string)
gsub("([[:digit:]] )(000)", "BLARG", string)
gsub("([[:digit:]][[:digit:]][[:digit:]] )(000)", "\\1,\\2", string)
gsub("([[:digit:]] )(000)", "\\1,\\2", string)
gsub("([[:digit:]])( )(000)", "\\1,\\2", string)
gsub("([[:digit:]])( )(000)", "\\1,\\3", string)
View(words_near_numbers_df_currency)
View(words_near_numbers_df_currency)
# Explore Patterns in Data
# Load Data --------------------------------------------------------------------
srar_df <- readRDS(file.path(rawdata_file_path, "mergedFiles","srar_dau_bsc_merged_cleaned_metrics.Rds"))
# Determine words that are near numbers ----------------------------------------
extract_words_near_strings <- function(string, near){
words <- strsplit(string, " ")[[1]]
number_indices <- which(!is.na(as.numeric(words)))
words_df <- lapply(number_indices, function(index){
indices_check <- c(index-1:near,index, index+1:near)
indices_check <- indices_check[indices_check > 0]
indices_check <- indices_check[indices_check <= length(words)]
indices_check <- min(indices_check):max(indices_check)
words_near_indices <- words[indices_check] %>% t %>% as.data.frame
names(words_near_indices) <- gsub("-","m",paste0("V",indices_check-index))
return(words_near_indices)
}) %>% bind_rows
return(words_df)
}
words_near_numbers_df <- lapply(srar_df$commentaire_srar, extract_words_near_strings, 2) %>% bind_rows
words_near_numbers_df$words_all <- paste(words_near_numbers_df$Vm2, words_near_numbers_df$Vm1,
words_near_numbers_df$V0,
words_near_numbers_df$V1, words_near_numbers_df$V2)
# Grab ones with a currency
words_near_numbers_df_currency <- words_near_numbers_df[grepl(paste(CURRENCY_WORDS, collapse="|"), words_near_numbers_df$words_all),]
View(words_near_numbers_df_currency)
head(words_near_numbers_df_currency)
words_near_numbers_df_currency <- subset(words_near_numbers_df_currency, select=c(Vm2, Vm1, V0, V1, V2, words_all))
View(words_near_numbers_df_currency)
View(words_near_numbers_df_currency)
View(words_near_numbers_df_currency)
head(words_near_numbers_df)
head(srar_bsc_df)
# Append Comments Files
# TODO
# 1. Data variables are importing weirdly from excel
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "Z:"
srar_comments_file_path <- file.path(project_file_path, "Experiment","Data","DATAIN","SRAR_Comments")
library(readxl)
library(dplyr)
library(chron)
LOAD_RAW_SRAR_STATA_FILE <- FALSE # It TRUE, loads data file and saves as Rds file
# Load SRAR Data ---------------------------------------------------------------
if(LOAD_RAW_SRAR_STATA_FILE){
srar_df <- read_dta(file.path(project_file_path, "Madagascar_project", "Old_data_management", "Eva","Qualitative_comments", "Database", "Final output","srar.dta"))
saveRDS(srar_df, file=file.path(project_file_path, "Madagascar_project", "dataOUT", "commentsOUT","rawdata","individualFiles","srar.rds"))
} else{
srar_df <- readRDS(file=file.path(project_file_path, "Madagascar_project", "dataOUT", "commentsOUT","rawdata","individualFiles","srar.rds"))
}
# Load and Prep Data BSC Files -------------------------------------------------
srar_bsc_df <- list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T)[3] %>%
lapply(read_excel) %>%
lapply(function(df) as.data.frame(df)[c(-1,-2),]) %>%
bind_rows
names(srar_bsc_df) <- c("date_du_rapport","numero_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
# Load and Prep Data DAU Files -------------------------------------------------
# Files have different structures, so load and clean manually
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"))
names(dau_1) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_1 <- dau_1[c(-1,-2),]
dau_2 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-03-0801.nopag.xls"))
names(dau_2) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_2 <- dau_2[c(-1,-2),]
dau_3 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-10-0801.nopag.xls"))
names(dau_3) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_3 <- dau_3[c(-1,-2),]
dau_4 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-17-0801.nopag.xls"))
names(dau_4) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","certificat_de_visite","droit_compromis")
dau_4 <- dau_4[c(-1,-2),]
dau_5 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-24-0801.nopag.xls"))
names(dau_5) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","commentaire_profiler")
dau_5 <- dau_5[c(-1,-2),]
dau_6 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-01-0801.nopag.xls"))
names(dau_6) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_6 <- dau_6[c(-1,-2),]
dau_7 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-08-0801.nopag.xls"))
names(dau_7) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_7 <- dau_7[c(-1,-2),]
dau_8 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-15-0801.nopag.xls"))
names(dau_8) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_8 <- dau_8[c(-1,-2),]
dau_9 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-29-0801.nopag.xls"))
names(dau_9) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_9 <- dau_9[c(-1,-2),]
dau_10 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2019-01-19-0801.nopag.xls"))
names(dau_10) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_10 <- dau_10[c(-1,-2),]
dau_11 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_10192018.xls"))
names(dau_11) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_11 <- dau_11[c(-1,-2),]
dau_12 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_hebdo.xls"))
names(dau_12) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar", "date_selection","circuit_srar","certificat_de_visite","droit_compromis")
dau_12 <- dau_12[c(-1,-2),]
dau_13 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_hebdo_11262018.xls"))
names(dau_13) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_13 <- dau_13[c(-1),]
srar_dau_df <- bind_rows(dau_1, dau_2, dau_3, dau_4, dau_5, dau_6, dau_7, dau_8,
dau_9, dau_10, dau_11, dau_12, dau_13)
srar_dau_df <- unique(srar_dau_df)
head(srar_bsc_df)
#### Format date_du_rapport
srar_bsc_df$date_du_rapport
srar_bsc_df$date_du_rapport
srar_dau_df$date_du_rapport
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"))
names(dau_1) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_1$date_du_rapport
head(dau_1)
head(read_excel)
help(read_excel)
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), col_types="text")
head(dau_1)
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), col_types="date")
head(dau_1)
names(dau_1) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_1 <- dau_1[c(-1,-2),]
head(dau_1)
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), skip=1)
head(dau_1)
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), skip=2)
head(dau_1)
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), skip=2)
names(dau_1) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_1 <- dau_1[c(-1,-2),]
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), skip=2)
names(dau_1) <- c("date_du_rapport","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
head(dau_1)
# Append Comments Files
# TODO
# 1. Data variables are importing weirdly from excel
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "Z:"
srar_comments_file_path <- file.path(project_file_path, "Experiment","Data","DATAIN","SRAR_Comments")
library(readxl)
library(dplyr)
library(chron)
LOAD_RAW_SRAR_STATA_FILE <- FALSE # It TRUE, loads data file and saves as Rds file
# Load SRAR Data ---------------------------------------------------------------
if(LOAD_RAW_SRAR_STATA_FILE){
srar_df <- read_dta(file.path(project_file_path, "Madagascar_project", "Old_data_management", "Eva","Qualitative_comments", "Database", "Final output","srar.dta"))
saveRDS(srar_df, file=file.path(project_file_path, "Madagascar_project", "dataOUT", "commentsOUT","rawdata","individualFiles","srar.rds"))
} else{
srar_df <- readRDS(file=file.path(project_file_path, "Madagascar_project", "dataOUT", "commentsOUT","rawdata","individualFiles","srar.rds"))
}
# Load and Prep Data BSC Files -------------------------------------------------
srar_bsc_df <- list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T)[3] %>%
lapply(read_excel) %>%
lapply(function(df) as.data.frame(df)[c(-1,-2),]) %>%
bind_rows
names(srar_bsc_df) <- c("date_du_rapport","numero_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
# Load and Prep Data DAU Files -------------------------------------------------
# Files have different structures, so load and clean manually
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), skip=2)
names(dau_1) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
#dau_1 <- dau_1[c(-1,-2),]
dau_2 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-03-0801.nopag.xls"), skip=2)
names(dau_2) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_3 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-10-0801.nopag.xls"), skip=2)
names(dau_3) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_4 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-17-0801.nopag.xls"), skip=2)
names(dau_4) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","certificat_de_visite","droit_compromis")
dau_5 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-24-0801.nopag.xls"), skip=2)
names(dau_5) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","commentaire_profiler")
dau_6 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-01-0801.nopag.xls"), skip=2)
names(dau_6) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_7 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-08-0801.nopag.xls"), skip=2)
names(dau_7) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_8 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-15-0801.nopag.xls"), skip=2)
names(dau_8) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_9 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-29-0801.nopag.xls"), skip=2)
names(dau_9) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_10 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2019-01-19-0801.nopag.xls"), skip=2)
names(dau_10) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_11 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_10192018.xls"), skip=2)
names(dau_11) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_12 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_hebdo.xls"), skip=2)
names(dau_12) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar", "date_selection","circuit_srar","certificat_de_visite","droit_compromis")
dau_13 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_hebdo_11262018.xls"), skip=2)
names(dau_13) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
srar_dau_df <- bind_rows(dau_1, dau_2, dau_3, dau_4, dau_5, dau_6, dau_7, dau_8,
dau_9, dau_10, dau_11, dau_12, dau_13)
srar_dau_df <- unique(srar_dau_df)
# Append -----------------------------------------------------------------------
#### Add "type" for original dataset that observation came from
srar_bsc_df$type <- "BSC"
srar_dau_df$type <- "DAU"
srar_df$type <- "srar_historic"
#### Format date_du_rapport
#### Format date_du_rapport
srar_bsc_df$date_selection
srar_dau_df$date_selection
head(srar_bsc_df)
list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T)[3]
list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T)[3] %>%
lapply(read_excel)
# Load and Prep Data BSC Files -------------------------------------------------
srar_bsc_df <- list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T)[3] %>%
lapply(read_excel) %>%
lapply(function(df) as.data.frame(df)[c(-1,-2),]) %>%
bind_rows
list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T)
# Load and Prep Data BSC Files -------------------------------------------------
srar_bsc_df <- list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T) %>%
lapply(read_excel) %>%
lapply(function(df) as.data.frame(df)[c(-1,-2),]) %>%
bind_rows
nrow(srar_bsc_df)
# Load and Prep Data BSC Files -------------------------------------------------
srar_bsc_df <- list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T)[3] %>%
lapply(read_excel) %>%
lapply(function(df) as.data.frame(df)[c(-1,-2),]) %>%
bind_rows
nrow(srar_bsc_df)
# Load and Prep Data BSC Files -------------------------------------------------
srar_bsc_df <- list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T) %>%
lapply(read_excel, skip=2) %>%
#lapply(function(df) as.data.frame(df)) %>%
bind_rows
nrow(srar_bsc_df)
View(srar_bsc_df)
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), skip=2)
View(dau_1)
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), skip=2)
names(dau_1) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
View(dau_1)
head(dau_1)
# Append Comments Files
# TODO
# 1. Data variables are importing weirdly from excel
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "Z:"
srar_comments_file_path <- file.path(project_file_path, "Experiment","Data","DATAIN","SRAR_Comments")
library(readxl)
library(dplyr)
library(chron)
LOAD_RAW_SRAR_STATA_FILE <- FALSE # It TRUE, loads data file and saves as Rds file
# Load SRAR Data ---------------------------------------------------------------
if(LOAD_RAW_SRAR_STATA_FILE){
srar_df <- read_dta(file.path(project_file_path, "Madagascar_project", "Old_data_management", "Eva","Qualitative_comments", "Database", "Final output","srar.dta"))
saveRDS(srar_df, file=file.path(project_file_path, "Madagascar_project", "dataOUT", "commentsOUT","rawdata","individualFiles","srar.rds"))
} else{
srar_df <- readRDS(file=file.path(project_file_path, "Madagascar_project", "dataOUT", "commentsOUT","rawdata","individualFiles","srar.rds"))
}
# Load and Prep Data BSC Files -------------------------------------------------
srar_bsc_df <- list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T) %>%
lapply(read_excel, skip=2) %>%
bind_rows
names(srar_bsc_df) <- c("date_du_rapport","numero_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
# Load and Prep Data DAU Files -------------------------------------------------
# Files have different structures, so load and clean manually
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), skip=2)
names(dau_1) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
#dau_1 <- dau_1[c(-1,-2),]
dau_2 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-03-0801.nopag.xls"), skip=2)
names(dau_2) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_3 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-10-0801.nopag.xls"), skip=2)
names(dau_3) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_4 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-17-0801.nopag.xls"), skip=2)
names(dau_4) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","certificat_de_visite","droit_compromis")
dau_5 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-24-0801.nopag.xls"), skip=2)
names(dau_5) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","commentaire_profiler")
dau_6 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-01-0801.nopag.xls"), skip=2)
names(dau_6) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_7 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-08-0801.nopag.xls"), skip=2)
names(dau_7) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_8 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-15-0801.nopag.xls"), skip=2)
names(dau_8) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_9 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-29-0801.nopag.xls"), skip=2)
names(dau_9) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_10 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2019-01-19-0801.nopag.xls"), skip=2)
names(dau_10) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_11 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_10192018.xls"), skip=2)
names(dau_11) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_12 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_hebdo.xls"), skip=2)
names(dau_12) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar", "date_selection","circuit_srar","certificat_de_visite","droit_compromis")
dau_13 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_hebdo_11262018.xls"), skip=2)
names(dau_13) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
srar_dau_df <- bind_rows(dau_1, dau_2, dau_3, dau_4, dau_5, dau_6, dau_7, dau_8,
dau_9, dau_10, dau_11, dau_12, dau_13)
srar_dau_df <- unique(srar_dau_df)
# Append -----------------------------------------------------------------------
#### Add "type" for original dataset that observation came from
srar_bsc_df$type <- "BSC"
srar_dau_df$type <- "DAU"
srar_df$type <- "srar_historic"
#### Format date_du_rapport
#### Format date_du_rapport
srar_bsc_df$date_selection
srar_dau_df$date_selection
srar_bsc_df$date_bsc
srar_dau_df$date_bsc
head(srar_bsc_df)
head(srar_bsc_df)
# Append Comments Files
# TODO
# 1. Data variables are importing weirdly from excel
# Setup ------------------------------------------------------------------------
if(Sys.info()[["user"]] == "WB521633") project_file_path <- "Z:"
srar_comments_file_path <- file.path(project_file_path, "Experiment","Data","DATAIN","SRAR_Comments")
library(readxl)
library(dplyr)
library(chron)
LOAD_RAW_SRAR_STATA_FILE <- FALSE # It TRUE, loads data file and saves as Rds file
# Load SRAR Data ---------------------------------------------------------------
if(LOAD_RAW_SRAR_STATA_FILE){
srar_df <- read_dta(file.path(project_file_path, "Madagascar_project", "Old_data_management", "Eva","Qualitative_comments", "Database", "Final output","srar.dta"))
saveRDS(srar_df, file=file.path(project_file_path, "Madagascar_project", "dataOUT", "commentsOUT","rawdata","individualFiles","srar.rds"))
} else{
srar_df <- readRDS(file=file.path(project_file_path, "Madagascar_project", "dataOUT", "commentsOUT","rawdata","individualFiles","srar.rds"))
}
# Load and Prep Data BSC Files -------------------------------------------------
srar_bsc_df <- list.files(path=file.path(srar_comments_file_path),
pattern = "BSC_*",
full.names=T) %>%
lapply(read_excel, skip=2) %>%
bind_rows
names(srar_bsc_df) <- c("date_bsc","numero_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
# Load and Prep Data DAU Files -------------------------------------------------
# Files have different structures, so load and clean manually
dau_1 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-10-27-0801.nopag.xls"), skip=2)
names(dau_1) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
#dau_1 <- dau_1[c(-1,-2),]
dau_2 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-03-0801.nopag.xls"), skip=2)
names(dau_2) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_3 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-10-0801.nopag.xls"), skip=2)
names(dau_3) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_4 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-17-0801.nopag.xls"), skip=2)
names(dau_4) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","certificat_de_visite","droit_compromis")
dau_5 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-11-24-0801.nopag.xls"), skip=2)
names(dau_5) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","commentaire_profiler")
dau_6 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-01-0801.nopag.xls"), skip=2)
names(dau_6) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_7 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-08-0801.nopag.xls"), skip=2)
names(dau_7) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_8 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-15-0801.nopag.xls"), skip=2)
names(dau_8) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_9 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2018-12-29-0801.nopag.xls"), skip=2)
names(dau_9) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_10 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection-2019-01-19-0801.nopag.xls"), skip=2)
names(dau_10) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
dau_11 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_10192018.xls"), skip=2)
names(dau_11) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar","date_selection","circuit_srar")
dau_12 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_hebdo.xls"), skip=2)
names(dau_12) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar", "date_selection","circuit_srar","certificat_de_visite","droit_compromis")
dau_13 <- read_excel(file.path(srar_comments_file_path, "DAU_liq_bsc_selection_hebdo_11262018.xls"), skip=2)
names(dau_13) <- c("dau","liquidation","numero_bsc","date_bsc","nom_equipe","commentaire_srar", "date_selection","circuit_srar","commentaire_profiler","certificat_de_visite","droit_compromis")
srar_dau_df <- bind_rows(dau_1, dau_2, dau_3, dau_4, dau_5, dau_6, dau_7, dau_8,
dau_9, dau_10, dau_11, dau_12, dau_13)
srar_dau_df <- unique(srar_dau_df)
# Append -----------------------------------------------------------------------
#### Add "type" for original dataset that observation came from
srar_bsc_df$type <- "BSC"
srar_dau_df$type <- "DAU"
srar_df$type <- "srar_historic"
#### Format date_du_rapport
head(srar_bsc_df)
head(srar_dau_df)
srar_dau_df$date_bsc
head(srar_df)
#### Format date_du_rapport
srar_bsc_df$date_selection
srar_dau_df$date_selection
#### Format date_du_rapport
srar_bsc_df$date_selection
srar_dau_df$date_selection
srar_bsc_df$date_bsc
srar_dau_df$date_bsc
#### Format date_du_rapport
srar_bsc_df$date_selection
srar_dau_df$date_selection
srar_bsc_df$date_bsc
srar_dau_df$date_bsc
head(srar_df_all)
srar_df_all <- bind_rows(srar_df, srar_bsc_df, srar_dau_df)
